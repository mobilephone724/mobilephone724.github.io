<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
   <meta name="description" content="A datum in PostgreSQL is a generic data type that

either a value of a pass-by-value type or a pointer to a
value of a pass-by-reference type.
Therefore, we require:
sizeof(Datum) == sizeof(void *) == 8 (on 64-bit systems.) 
CStringGetDatum
CStringGetDatum and its inversity DatumGetCString are plain pointer
conversion functions.
static inline Datum
CStringGetDatum(const char *X)
{
	return PointerGetDatum(X);
}

static inline char *
DatumGetCString(Datum X)
{
	return (char *) DatumGetPointer(X);
}
CStringGetTextDatum
CStringGetTextDatum and its inversity TextDatumGetCString are functions
that convert between C string and PostgreSQL text type.">  

  <title>
    
      CStringGetTextDatum and CStringGetDatum
    
  </title>


  <link rel="shortcut icon" type="image/x-icon" href="/" />
  
  
  
  <link rel="stylesheet" href="/css/main.51652302d3a998bf7887aed5c2cf89141bbebdf45a2c8f87b0717a3cf4f51c4e53c694c328fb1de78c3a625a1c01f80745bf1f2f42c040647a245cbbb6c2d1d7.css" integrity="sha512-UWUjAtOpmL94h67Vws&#43;JFBu&#43;vfRaLI&#43;HsHF6PPT1HE5TxpTDKPsd54w6YlocAfgHRb8fL0LAQGR6JFy7tsLR1w==" />
  
</head>
<body a="auto">
        <main class="page-content" aria-label="Content">
            <div class="w">
                <div class="post-meta">
                    <a href="/">..</a>

                    <p>
                        <time datetime="2025-10-27 23:35:17 &#43;0800 CST">
                            2025-10-27
                        </time>
                    </p>
                </div>

<article>
    <h1>CStringGetTextDatum and CStringGetDatum</h1>

    

    <p>A <code>datum</code> in PostgreSQL is a generic data type that</p>
<blockquote>
<p>either a value of a pass-by-value type or a pointer to a
value of a pass-by-reference type.</p></blockquote>
<p>Therefore, we require:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>sizeof(Datum) == sizeof(void *) == 8 (on 64-bit systems.) 
</span></span></code></pre></div><h1 id="cstringgetdatum">CStringGetDatum</h1>
<p><code>CStringGetDatum</code> and its inversity <code>DatumGetCString</code> are plain pointer
conversion functions.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#f00">static</span> <span style="color:#f00">inline</span> Datum
</span></span><span style="display:flex;"><span><span style="color:#ff0">CStringGetDatum</span>(<span style="color:#f00">const</span> <span style="color:#ee82ee">char</span> *X)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#f00">return</span> <span style="color:#ff0">PointerGetDatum</span>(X);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">static</span> <span style="color:#f00">inline</span> <span style="color:#ee82ee">char</span> *
</span></span><span style="display:flex;"><span><span style="color:#ff0">DatumGetCString</span>(Datum X)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#f00">return</span> (<span style="color:#ee82ee">char</span> *) <span style="color:#ff0">DatumGetPointer</span>(X);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h1 id="cstringgettextdatum">CStringGetTextDatum</h1>
<p><code>CStringGetTextDatum</code> and its inversity <code>TextDatumGetCString</code> are functions
that convert between C string and PostgreSQL <code>text</code> type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-txt" data-lang="txt"><span style="display:flex;"><span>CStringGetTextDatum
</span></span><span style="display:flex;"><span>\__ cstring_to_text
</span></span><span style="display:flex;"><span>	\__ cstring_to_text_with_len(const char *s, int len)
</span></span><span style="display:flex;"><span>		\__ palloc
</span></span><span style="display:flex;"><span>		\__ memcpy
</span></span></code></pre></div><p>Note that <code>CStringGetTextDatum</code> generate a malloced object to return.</p>
<p>The structure of <code>text</code> type generated by the code path above is as follows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-C" data-lang="C"><span style="display:flex;"><span><span style="color:#0f0">/* Variable-length datatypes all share the &#39;struct varlena&#39; header. */</span>
</span></span><span style="display:flex;"><span><span style="color:#f00">struct</span> varlena
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">char</span>		vl_len_[<span style="color:#f60">4</span>];		<span style="color:#0f0">/* Do not touch this field directly! */</span>
</span></span><span style="display:flex;"><span>	<span style="color:#ee82ee">char</span>		vl_dat[FLEXIBLE_ARRAY_MEMBER];	<span style="color:#0f0">/* Data content is here */</span>
</span></span><span style="display:flex;"><span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f00">typedef</span> <span style="color:#f00">struct</span> varlena text;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#0f0">/*
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"> * vl_len_ = len &lt;&lt; 2
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"> * vl_dat  = s
</span></span></span><span style="display:flex;"><span><span style="color:#0f0"> */</span>
</span></span></code></pre></div><p>Note that <code>vl_len_ = len &lt;&lt; 2</code>, which means that we can NOT generate a quite
long text (greater than 2^30 bytes) in this way. (What are other code paths to
generate a long or compressed text?)</p>

</article>

            </div>
        </main>
    </body></html>
